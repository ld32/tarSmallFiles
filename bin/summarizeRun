#!/bin/bash

#set -x


dFolder="$1"

echo 
echo -------------------------------------------------- 
echo ${dFolder}Log
#dFolder=aaronsBrain--sections
    logDir=${dFolder}Log

    x=$(wc -l < $logDir/folders.txt)  

    rows_per_job=1000
    nJobs=$(( (x + rows_per_job - 1) / rows_per_job ))

    count=0;
    for i in `seq 1 $nJobs`; do 
        #[ -f $logDir/slurm.$i.txt ] && log=$logDir/slurm.$i.txt || log=$logDir/slurm.$i.1.txt
        { tail -n 50 $logDir/slurm.$i.txt  2>/dev/null;  tail -n 50 $logDir/slurm.$i.1.txt  2>/dev/null; } | grep "^$i end time" 1>/dev/null && count=$((count+1)) || echo $i not done 

    done     

    #[ -f $logDir/allDone1 ] && count=$nJobs || count=`grep "end time" $logDir/slurm.*.txt 2>/dev/null | wc -l`
    
    if [ $count -ge $nJobs ]; then 
        #touch $logDir/allDone
            echo All $nJobs jobs are done already  ++++++++++++++++++   
        pass=`cat $logDir/foldersPass.*.txt | wc -l | cut -d' ' -f1` 
        total=`wc -l $logDir/folders.txt | cut -d' ' -f1`
        if [ "$pass" -eq "$total" ]; then
            echo All $total folders passed.  ++++++++++++++++++
        else 
            echo $pass/$total folders passed the validation. Need rerun: $((total-pass))
            #grep "Err" $logDir/slurm* 
        fi 
    else 
        echo $count of $nJobs are done. 
        checkJobs $dFolder; 
        
    fi 

